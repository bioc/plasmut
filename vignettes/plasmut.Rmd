---
title: "Walkthrough of plasmut package use for matched white blood cell and cell-free DNA mutants sequenced"
author: "Adith S. Arun and Robert B. Scharpf"
date: "`r format(Sys.Date())`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{plasmut}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
An example workflow of the plasmut package is shown using data from the CAIRO5 study (van't Erve and Medina et. al 2022). For a group of patients with cancer, both cell-free DNA and white blood cell DNA were sequenced. The distinct and total reads for each mutation present in cell-free DNA are displayed in the data. Corresponding white blood cell total and distinct reads are displayed as well.

From this information, we wish to assign labels to each of the mutations. Specifically, for mutations seen in cell-free DNA and not in white blood cells (distinct reads wbc = 0), we estimate the probability that the mutation arises from the tumor. This is done in a Bayesian framework and approximates integrals as Monte Carlo sums. Please see the paper for a workthrough of the math underlying this. Additionally, for mutations seen in white blood cells and cell-free DNA, we classify them as either hematopoietic or germline variants in an unsupervised manner.

```{r setup, message=FALSE}
library(plasmut)
library(tidyverse)
library(rjags)
library(ggmcmc)
```

Read in the data and convert columns to their natural types.
```{r load data}
extdir <- system.file("extdata", package="plasmut")
fpath <- file.path(extdir, "cairo5-matched-sequencing.csv")

df <- read_csv(fpath, show_col_types=FALSE) %>% type.convert(as.is=TRUE)
```

Here is what a sample of the relevant data from the dataframe looks like:  
```{r sample columns of data frame to show for paper}
df %>% select(Gene, Patient, `cfDNA distinct mutant reads`, `cfDNA distinct reads`, `wbc distinct reads`, `wbc distinct mutant reads`) %>% slice(1:4)
```

Select the relevant columns with total and mutant reads in cfDNA and white blood cell fractions for each mutation. (nw = total WBC reads, np = total cfDNA reads, pw = mutant WBC reads, pw = mutant cfDNA reads)  
```{r get relevant data}
data <- df %>% select(8:11) %>% magrittr::set_colnames(c("np", "yp", "nw", "yw")) %>% mutate(yw=ifelse(is.na(yw), 0, yw), nw = ifelse(is.na(nw), 1e8, nw)) %>% as.list()
```

Call the plasmut function `compute_p_tumor()` that computes the probability of a mutation being tumor derived.  

We can adjust the `rho_ctc_parameter` in the `compute_p_tumor()` function to reflect our apriori assumptions about the fraction of cells in the buffy coat layer that are circulating tumor cells (CTCs). By default, it is assumed that `rho_ctc_parameter = 0`, but this can be changed. A value of 1e-3 may be a good place to start (1 CTC: 1000 WBCs) if CTCs are suspected to be present in the white blood cell fraction.  
```{r compute prob tumor, warning=FALSE}
model_results <- compute_p_tumor(data, rho=0.001) #rho is 1:1000
```
The object model_results contains two items, the bayes factors (`model_results$bf`) and the estimated tumor-specific probabilities (`model_results$p`).  


Call the plasmut function `stratify_wbc_vars` that identifies which white blood cell mutants are germline versus hematopoietic.    

```{r stratify wbc variants}
cols <- c("cfDNA distinct mutant reads",
          "cfDNA distinct reads",
          "wbc distinct mutant reads",
          "wbc distinct reads")

wbc.var.type <- stratify_wbc_vars(data=df,
                                  cols=cols)
```

Compute mutant allele fractions (MAFs) for WBC and cell-free fractions. Also, clean data.  

```{r data cleaning and organization}
df <- df %>%
    mutate(prob.tumor.specific=model_results$p, bayes.factor=model_results$bf, 
           wbc.var.type=wbc.var.type) %>%
    mutate(wbcmaf=`wbc distinct mutant reads`/`wbc distinct reads`,
           cfdnamaf=`cfDNA distinct mutant reads`/`cfDNA distinct reads`) %>%
    mutate(cfdnamaf=ifelse(is.nan(cfdnamaf), 0, cfdnamaf)) 

df <- df %>% filter((g_include == "yes"|type=="Circulating Tumor Cell"))

df %>% relocate(Gene, Patient, prob.tumor.specific, bayes.factor, cfdnamaf, wbcmaf) %>% head()
```

We can assess the accuracy of our estimation procedure by sequencing the tumor and observing whether the mutation is found there. We sequenced 42 cases where the tumor displayed the same variant as the cell-free DNA. Our estimation procedure assigned a probability of tumor of 1 to 41 of these cases and a probability of 0.998 to the other, which was consistent with the tumor sequencing results.

```{r estimation accuracy}
df %>% select(cfdnamaf, wbcmaf, prob.tumor.specific, type) %>%
    filter(type=="Tumor-confirmed") %>%
    ## @ again, this is an odds and not a probability
    mutate(prob.tumor.specific = round(prob.tumor.specific, 3)) %>%
    group_by(prob.tumor.specific) %>%
    summarize(category=unique(type), n=n())
```

Finally, we can visualize the results of this approach
```{r visualization of CTC model, fig.align="center", fig.width=9, fig.height=6, warning=FALSE}
cluster.annotate <- df %>% select(wbc.var.type, cfdnamaf, wbcmaf) %>% group_by(wbc.var.type) %>% summarize(wbclevel=mean(wbcmaf)) %>% arrange(desc(wbclevel)) %>% filter(!is.na(wbc.var.type))

df <- df %>% mutate(status = wbc.var.type) %>% mutate(status = ifelse((is.na(status)|(type=="Circulating Tumor Cell")), "Likely tumor-specific", wbc.var.type)) %>% mutate(status = ifelse(status==cluster.annotate$wbc.var.type[1], "Germline variants", status)) %>% mutate(status = ifelse(status==cluster.annotate$wbc.var.type[2], "Hematopoietic variants", status)) %>% mutate(prob=status) %>% mutate(prob=ifelse(status=="Likely tumor-specific", prob.tumor.specific, prob)) %>% mutate(prob=ifelse(status=="Germline variants", -2, prob), prob=ifelse(status=="Hematopoietic variants", -1, prob)) %>% mutate(prob=as.numeric(prob))

df <- df %>% mutate(shapestatus=ifelse(type=="Tumor-confirmed", "Tumor confirmed\nby sequencing", "Tumor not sequenced"))

cfvar_plot <- ggplot(df, aes(x=wbcmaf, y=cfdnamaf)) +
    geom_jitter(aes(color = prob, fill = status, shape=shapestatus),
                fill = "black", stat = "identity", lwd = 3, width = 0.1, alpha = 0.7) +
    scale_color_gradientn(colors = c("red3", "darkgreen", "darkgreen", "blue", "purple"),
                          na.value = "transparent",
                          breaks = c(-2, -1, 0, 0.8, 1),
                          labels=c("Germline variants", "Hematopoietic variants",0,  0.8, 1),
                          limits=c(-2, 1)) +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1),
                       breaks=c(0.000084, 0.001, 0.01,  0.1, 0.5),
                       trans='log10',
                       oob = scales::squish_infinite) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 0.1),
                       breaks=c(0.000084, 0.001, 0.01,  0.1, 1),
                       trans='log10',
                       oob = scales::squish_infinite) +
    scale_shape_manual(values = c(17, 16)) +
    labs(x="White blood cell MAF (%)",
          y="cfDNA MAF (%)")+
    theme_bw() +
    theme(
      plot.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      plot.tag = element_text()) +
    theme(axis.line = element_line(color = 'black')) +
    theme(axis.text.x = element_text(vjust=1.2, hjust= 0.3)) 

cfvar_plot <- cfvar_plot +
    theme(#legend.direction = "vertical", legend.box = "horizontal",
          legend.background = element_rect(fill = "transparent"),
          legend.position="right", legend.direction="vertical",
          #legend.position = c(0.47, 0.88),
          legend.key = element_rect(size = 5), #legend.box.background = element_rect(colour = "black"),
          legend.key.size = unit(0.4, "cm")) +
    guides(color=guide_legend(title="Probability\nTumor-Specific", nrow = 6),
           fill = guide_legend(title=""),
           shape = guide_legend(title=""), nrow=2) +
    geom_vline(xintercept=c(0.00015), linetype="dashed", size = 0.2) +
    geom_vline(xintercept=c(0.00009), linetype="dashed", size = 0.2, color = NA) +
    geom_vline(xintercept=c(0.25), linetype="dashed", size = 0.2) +
    geom_abline(slope=1, intercept=0, color="gray", alpha = 0.4, size = 0.4)

cfvar_plot + theme(axis.title=element_text(size=16), axis.text=element_text(size=13), legend.text=element_text(size=12), legend.title=element_text(size=14))
```

There are a number of mutations with a probability of being tumor specific below 0.9. We can notice that although the white blood cell MAF is zero for these mutations, the number of cell-free DNA mutant reads is very low relative to the total reads. This naturally, introduces some doubt into our minds as to whether the mutant reads are tumor specific, or arising from a different process / tissue. This uncertainty is quantified in our method with reduced probability estimates, something a binary "tumor or not" approach does not capture.
```{r lower probability tumor specific mutations}
df %>% filter(wbcmaf == 0) %>% arrange(prob) %>% select(prob, `cfDNA distinct mutant reads`, `cfDNA distinct reads`, `wbc distinct mutant reads`, `wbc distinct reads`, type, Gene, Patient) %>% slice(1:10)
```

We expect there to be a near linear relationship between the bayes factors and probabilities for a given mutation, which we can observe by plotting these two quantities.  
```{r bayes factor relationship to cfDNA, fig.align="center", fig.width=5, fig.height=5, warning=FALSE, message=FALSE, echo=FALSE, results='hide'}
cor.val <- df %>% select(prob.tumor.specific, bayes.factor, cfdnamaf, wbcmaf, Gene, Patient) %>% mutate(logbf=log(bayes.factor)) %>% filter(!is.infinite(logbf)) %>% select(cfdnamaf, logbf) %>% cor(method="spearman") %>% as_tibble() %>% slice(1) %>% pull(logbf) %>% round(2)

corr <- paste0("Corr: ", cor.val)

plt <- df %>% select(prob.tumor.specific, bayes.factor, cfdnamaf, wbcmaf, Gene, Patient) %>% mutate(logbf=log(bayes.factor)) %>% filter(!is.infinite(logbf)) %>% ggplot(aes(x=logbf, y=cfdnamaf)) + geom_point(size=1.5) + theme_bw() + ylab("cfDNA MAF") + xlab("log(Bayes Factor)") + theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + geom_smooth(method="loess", se = F) 

#+ geom_text(x=400, y=0.22, label=corr, size=4)

plt
```

Another way to represent the probability of tumor specific estimates for each mutation is to create a gene by patient matrix and label tiles according to their status. We color a tile based on whether the underlying mutation is actually hematopoietic, germline, or somatic and outline the tile based on whether the bayes factor is above a certain level. Here, we choose the bayes factor level of 18.01 such that any value greater than this number represents a probability of tumor specific estimate of 0.9.  

The accuracy of our method can be assessed by noting the concordance between tile outlines and colors. For example, bayes factor > 18.01 outlined tiles almost always have a color corresponding to tumor and bayes factor < 18.01 tiles almost always have a germline or hematopoietic color. 
```{r tile plot, fig.height=6, fig.width=10, fig.align="center"}
plt.df <- df %>% select(status, Gene, Patient, bayes.factor) %>% mutate(border=ifelse(bayes.factor > 18.01, "> 18.01", "Else")) %>% select(-bayes.factor) %>% mutate(alt.source=ifelse(status=="Likely tumor-specific", "Tumor", status)) %>% select(-status)

ordered.levels <- plt.df %>% group_by(Gene) %>% summarize(n=n()) %>% arrange(desc(n)) %>% pull(Gene)

gene.numbers <- plt.df %>% select(Gene) %>% distinct() %>% mutate(gene.num=1:n())

plt.df <- plt.df %>% left_join(gene.numbers, by=c("Gene"="Gene"))

fig <- plt.df %>% ggplot(aes(y=factor(Gene, levels=ordered.levels), x=factor(Patient), fill=alt.source, color=border)) + geom_tile(size=1.25, alpha=0.7, width=0.85, height=0.75) + theme_minimal() + ylab("Gene") + xlab("Patient") + theme(panel.grid.major=element_blank()) + theme(axis.text.x=element_blank()) + scale_color_manual(values=c("firebrick", "darkblue"), name="Bayes Factor") + scale_fill_manual(values=c("mediumorchid", "cornflowerblue", "sienna"), name="Alteration\nSource")

fig
```


```{r sensitivity analyses, eval=FALSE, echo=FALSE, fig.width=7.84, fig.height=8.49, warning=FALSE}

df <- read_csv(fpath, show_col_types=FALSE) %>% type.convert(as.is=TRUE)

data <- df %>% select(8:11) %>% magrittr::set_colnames(c("np", "yp", "nw", "yw")) %>% mutate(yw=ifelse(is.na(yw), 0, yw), nw = ifelse(is.na(nw), 1e8, nw)) %>% as.list()


df <- df %>%
    mutate(wbcmaf=`wbc distinct mutant reads`/`wbc distinct reads`,
           cfdnamaf=`cfDNA distinct mutant reads`/`cfDNA distinct reads`) %>%
    mutate(cfdnamaf=ifelse(is.nan(cfdnamaf), 0, cfdnamaf)) 

rhonormal <- compute_p_tumor(data, rho = 0.001)
rhohigh <- compute_p_tumor(data, rho = 0.01)
rhozero <- compute_p_tumor(data, rho = 0)
rholow <- compute_p_tumor(data, rho = 1e-8)
flat <- compute_p_tumor(data, a_w_somatic = 1, b_w_somatic = 1, a_p_somatic = 1, b_p_somatic = 1, a_theta = 1, b_theta = 1)

get_cor_bf <- function(x,y){
  corr <- data.frame(a=log(x$bf), b=log(y$bf)) %>% as_tibble() %>% filter(is.finite(a), is.finite(b)) %>% cor() %>% as_tibble() %>% round(3) %>% slice(1) %>% pull(b)
  
  paste0("Corr: ", corr)
}

get_cor_p <- function(x, y){
  corr <- cor(x$p, y$p, use='pairwise.complete.obs') %>% round(., 3)
  
  paste0("Corr: ", corr)
}

#CTC 1:1000 to 1:100
a <- df %>% mutate(p=rhonormal$p, bf=rhonormal$bf, p2=rhohigh$p, bf2=rhohigh$bf) %>% filter(g_include=="yes") %>% ggplot(aes(x=log(bf), y=log(bf2))) + ylab("log(Bayes factors)\ngiven 1 CTC: 100 WBC") + xlab("log(Bayes factors)\ngiven 1 CTC: 1000 WBC") + geom_point(size = 1.5, alpha = 0.8, color="black") + geom_abline(slope = 1, intercept = 0, linetype="dashed", color="grey70") + theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color="black", fill=NA, size=0.5)) + geom_text(data.frame(x=520, y=-440, label=get_cor_bf(rhonormal, rhohigh)), mapping=aes(x=x, y=y, label=label), color="black", size=4, hjust='right', vjust='bottom')


b <- df %>% mutate(p=rhonormal$p, bf=rhonormal$bf, p2=rhohigh$p, bf2=rhohigh$bf) %>% filter(g_include=="yes") %>% ggplot(aes(x=p, y=p2)) + ylab("P(tumor)\ngiven 1 CTC: 100 WBC") + xlab("P(tumor) given 1 CTC: 1000 WBC") + geom_point(size = 1.5, alpha = 0.8, color="black") + geom_abline(slope = 1, intercept = 0, linetype="dashed", color="grey70") + theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color="black", fill=NA, size=0.5)) + geom_text(data.frame(x=1, y=0, label=get_cor_p(rhonormal, rhohigh)), mapping=aes(x=x, y=y, label=label), color="black", size=4, vjust='bottom', hjust='right')


#CTC 0 to 1e-8
c <- df %>% mutate(p=rhozero$p, bf=rhozero$bf, p2=rholow$p, bf2=rholow$bf) %>% filter(g_include=="yes") %>% ggplot(aes(x=log(bf), y=log(bf2))) + ylab("log(Bayes factors)\ngiven 0 CTCs") + xlab("log(Bayes factors)\ngiven 1 CTC: 1e8 WBC") + geom_point(size = 1.5, alpha = 0.8, color="black") + geom_abline(slope = 1, intercept = 0, linetype="dashed", color="grey70") + theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color="black", fill=NA, size=0.5)) + geom_text(data.frame(x=600, y=0, label=get_cor_bf(rhozero, flat)), mapping=aes(x=x, y=y, label=label), color="black", size=4, hjust='right', vjust='bottom')


d <- df %>% mutate(p=rhozero$p, bf=rhozero$bf, p2=rholow$p, bf2=rholow$bf) %>% filter(g_include=="yes") %>% ggplot(aes(x=p, y=p2)) + ylab("P(tumor)\ngiven 0 CTCs") + xlab("P(tumor) given 1 CTC: 1e8 WBC") + geom_point(size = 1.5, alpha = 0.8, color="black") + geom_abline(slope = 1, intercept = 0, linetype="dashed", color="grey70") + theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color="black", fill=NA, size=0.5)) +  geom_text(data.frame(x=1, y=0, label=get_cor_p(rhozero, rholow)), mapping=aes(x=x, y=y, label=label), color="black", size=4, vjust='bottom', hjust='right')


#Beta (1,10) to (1,1)
e <- df %>% mutate(p=rhozero$p, bf=rhozero$bf, p2=flat$p, bf2=flat$bf) %>% filter(g_include=="yes") %>% ggplot(aes(x=log(bf), y=log(bf2))) + ylab("log(Bayes factors)\ngiven beta(1,10) priors") + xlab("log(Bayes factors)\ngiven beta(1,1) priors") + geom_point(size = 1.5, alpha = 0.8, color="black") + geom_abline(slope = 1, intercept = 0, linetype="dashed", color="grey70") + theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color="black", fill=NA, size=0.5)) + geom_text(data.frame(x=600, y=0, label=get_cor_bf(rhozero, flat)), mapping=aes(x=x, y=y, label=label), color="black", size=4, hjust='right', vjust='bottom')


f <- df %>% mutate(p=rhozero$p, bf=rhozero$bf, p2=flat$p, bf2=flat$bf) %>% filter(g_include=="yes") %>% ggplot(aes(x=p, y=p2)) + ylab("P(tumor)\ngiven beta(1,10) priors") + xlab("P(tumor) given beta(1,1) priors") + geom_point(size = 1.5, alpha = 0.8, color="black") + geom_abline(slope = 1, intercept = 0, linetype="dashed", color="grey70") + theme_minimal() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color="black", fill=NA, size=0.5)) + geom_text(data.frame(x=1, y=0, label=get_cor_p(rhozero, flat)), mapping=aes(x=x, y=y, label=label), color="black", size=4, vjust='bottom', hjust='right')


#make into figure with cowplot::plot_grid

cowplot::plot_grid(a,b,c,d,e,f, nrow=3, labels="AUTO")

```

```{r, eval=FALSE, echo=FALSE}
#circulating tumor cell APC mutation sensitivity analysis
yp <- 2
np <- 9
yw <- 9
nw <- 1588

data$yw <- yw
data$nw <- nw

table.results <- data.frame()

for (y in c(1/10, 1/100, 1/1000)){
  for (x in c(1, 10, 100)){
    
    data$yp <- yp*x
    data$np <- np*x
    
    p <- compute_p_tumor(data, rho_ctc_parameter=y)$p
    
    res <- data.frame(yp=data$yp, np=data$np, rho=y, prob.tumor=p)
    
    table.results <- rbind(table.results, res)
  }
}

table.results %>% mutate(prob.tumor = round(prob.tumor, 3)) %>% pivot_wider(names_from=rho, values_from=prob.tumor) %>% knitr::kable()
```


